<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sala Mineira - Gerenciador de Currículos</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      /* Styles for the resume preview used in PDF generation */
      .resume-preview-pdf {
        position: absolute;
        left: -9999px;
        top: 0;
        width: 210mm;
        background: white;
        padding: 20mm;
        color: #000;
      }
    </style>
  </head>
  <body class="bg-slate-100 text-slate-800">
    <!-- This container will hold the entire app -->
    <div id="app-container">
      <!-- Login Section -->
      <div
        id="login-section"
        class="flex items-center justify-center min-h-screen"
      >
        <div
          class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg"
        >
          <div class="text-center">
            <img
              src="https://placehold.co/100x100/e2e8f0/475569?text=Logo"
              alt="Logo Prefeitura"
              class="w-24 h-24 mx-auto mb-4 rounded-full"
            />
            <h1 class="text-3xl font-bold text-slate-900">Sala Mineira</h1>
            <p class="text-slate-600">Gerenciador de Currículos</p>
          </div>
          <form id="login-form" class="space-y-4">
            <div>
              <label for="email" class="text-sm font-medium text-slate-700"
                >Email</label
              >
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-4 py-2 mt-1 text-slate-700 bg-slate-100 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label for="password" class="text-sm font-medium text-slate-700"
                >Senha</label
              >
              <input
                type="password"
                id="password"
                name="password"
                required
                class="w-full px-4 py-2 mt-1 text-slate-700 bg-slate-100 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <button
              type="submit"
              class="w-full py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300"
            >
              Entrar
            </button>
          </form>
          <p id="login-error" class="text-sm text-center text-red-500"></p>
        </div>
      </div>

      <!-- Main App Section (for logged-in users) -->
      <div id="app-section" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-40">
          <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
              <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold text-slate-800">
                  Sala Mineira CRM
                </h1>
              </div>
              <div class="flex items-center space-x-4">
                <span
                  id="user-email"
                  class="text-sm text-slate-600 hidden sm:block"
                ></span>
                <button
                  id="logout-button"
                  class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition"
                >
                  Sair <i class="fas fa-sign-out-alt ml-1"></i>
                </button>
              </div>
            </div>
          </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
          <div class="p-6 mb-8 bg-white rounded-xl shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="md:col-span-2">
                <label
                  for="filter-text"
                  class="text-sm font-medium text-slate-700"
                  >Filtrar por nome ou habilidade</label
                >
                <input
                  type="text"
                  id="filter-text"
                  placeholder="Ex: João da Silva, React, Vendas..."
                  class="w-full px-4 py-2 mt-1 text-slate-700 bg-slate-100 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>
              <div class="flex items-end">
                <button
                  id="add-resume-button"
                  class="w-full py-2.5 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition flex items-center justify-center space-x-2"
                >
                  <i class="fas fa-plus-circle"></i>
                  <span>Adicionar Currículo</span>
                </button>
              </div>
            </div>
          </div>

          <div
            id="resume-list"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          ></div>
          <div id="loading-indicator" class="text-center py-10">
            <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
            <p class="mt-2 text-slate-600">Carregando currículos...</p>
          </div>
          <div id="no-results" class="text-center py-10 hidden">
            <i class="fas fa-file-alt fa-3x text-slate-400"></i>
            <p class="mt-2 text-slate-600">Nenhum currículo encontrado.</p>
          </div>
        </main>
      </div>
    </div>
    <!-- End #app-container -->

    <!-- Resume Form Modal -->
    <div
      id="resume-modal"
      class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-60"
    >
      <div
        class="bg-white rounded-lg shadow-xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-y-auto"
      >
        <form id="resume-form" class="p-6">
          <input type="hidden" id="resume-id" />
          <h2 id="modal-title" class="text-2xl font-bold text-slate-900 mb-4">
            Adicionar Novo Currículo
          </h2>

          <!-- Form content will be injected here -->
          <div id="form-content-container"></div>

          <!-- Modal Actions -->
          <div class="flex justify-end pt-6 mt-4 border-t space-x-3">
            <button
              type="button"
              id="cancel-button"
              class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300"
            >
              Cancelar
            </button>
            <button
              type="submit"
              id="save-button"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Share Modal -->
    <div
      id="share-modal"
      class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-lg">
        <h3 class="text-xl font-bold">Compartilhar Currículo</h3>

        <div class="mt-4">
          <label class="font-semibold text-slate-700"
            >Link para Empresa (Somente Leitura)</label
          >
          <p class="text-sm text-slate-500 mb-2">
            Use este link para compartilhar com recrutadores.
          </p>
          <div class="flex items-center bg-slate-100 border rounded-lg p-2">
            <input
              type="text"
              id="share-link-company"
              readonly
              class="flex-grow bg-transparent outline-none text-sm"
            />
            <button
              data-target="share-link-company"
              class="copy-link-button ml-2 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
            >
              Copiar
            </button>
          </div>
        </div>

        <div class="mt-6">
          <label class="font-semibold text-slate-700"
            >Link para Candidato (Editável)</label
          >
          <p class="text-sm text-slate-500 mb-2">
            Envie este link para o candidato atualizar os próprios dados.
          </p>
          <div class="flex items-center bg-slate-100 border rounded-lg p-2">
            <input
              type="text"
              id="share-link-candidate"
              readonly
              class="flex-grow bg-transparent outline-none text-sm"
            />
            <button
              data-target="share-link-candidate"
              class="copy-link-button ml-2 px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm"
            >
              Copiar
            </button>
          </div>
        </div>

        <p
          id="copy-feedback"
          class="text-green-600 text-sm mt-3 h-4 text-center"
        ></p>
        <div class="text-right mt-4">
          <button
            id="close-share-modal"
            class="px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div
      id="confirm-modal"
      class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50"
    >
      <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md">
        <h3 id="confirm-title" class="text-xl font-bold">Confirmar Ação</h3>
        <p id="confirm-message" class="text-slate-600 mt-2">
          Você tem certeza?
        </p>
        <div class="flex justify-end mt-6 space-x-3">
          <button
            id="confirm-cancel-btn"
            class="px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300"
          >
            Cancelar
          </button>
          <button
            id="confirm-ok-btn"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <div id="pdf-content" class="resume-preview-pdf"></div>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        doc,
        getDoc,
        updateDoc,
        deleteDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- Firebase Configuration ---
      const firebaseConfig = {
        apiKey: "AIzaSyCWV4nL3mApcI63wn7f3eXQVdgGRop1tqw",
        authDomain: "resume-app-v1.firebaseapp.com",
        projectId: "resume-app-v1",
        storageBucket: "resume-app-v1.firebasestorage.app",
        messagingSenderId: "314397205311",
        appId: "1:314397205311:web:29fd7c17a120b369aea98a",
        measurementId: "G-D40BMC2QYZ",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let allResumes = [];
      let currentUserId = null;
      let confirmCallback = null;

      // --- DOM Elements ---
      const appContainer = document.getElementById("app-container");
      const loginSection = document.getElementById("login-section");
      const appSection = document.getElementById("app-section");
      const loginForm = document.getElementById("login-form");
      const loginError = document.getElementById("login-error");
      const userEmailSpan = document.getElementById("user-email");
      const logoutButton = document.getElementById("logout-button");
      const resumeList = document.getElementById("resume-list");
      const loadingIndicator = document.getElementById("loading-indicator");
      const noResults = document.getElementById("no-results");
      const filterInput = document.getElementById("filter-text");

      const resumeModal = document.getElementById("resume-modal");
      const resumeForm = document.getElementById("resume-form");
      const modalTitle = document.getElementById("modal-title");
      const formContainer = document.getElementById("form-content-container");
      const addResumeButton = document.getElementById("add-resume-button");
      const cancelButton = document.getElementById("cancel-button");

      const shareModal = document.getElementById("share-modal");
      const shareLinkCompanyInput =
        document.getElementById("share-link-company");
      const shareLinkCandidateInput = document.getElementById(
        "share-link-candidate"
      );
      const closeShareModal = document.getElementById("close-share-modal");
      const copyFeedback = document.getElementById("copy-feedback");

      const confirmModal = document.getElementById("confirm-modal");

      // --- Confirmation Modal Logic ---
      function showConfirm(title, message, callback) {
        document.getElementById("confirm-title").textContent = title;
        document.getElementById("confirm-message").textContent = message;
        confirmCallback = callback;
        confirmModal.classList.remove("hidden");
      }

      document
        .getElementById("confirm-ok-btn")
        .addEventListener("click", () => {
          if (confirmCallback) confirmCallback();
          confirmModal.classList.add("hidden");
        });
      document
        .getElementById("confirm-cancel-btn")
        .addEventListener("click", () => {
          confirmModal.classList.add("hidden");
        });

      // --- App Initializer ---
      function startApp() {
        const params = new URLSearchParams(window.location.search);
        const viewId = params.get("view");
        const editId = params.get("edit");

        if (viewId) {
          renderPublicView(viewId, false);
        } else if (editId) {
          renderPublicView(editId, true);
        } else {
          setupMainApp();
        }
      }

      // --- Main App Setup ---
      function setupMainApp() {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUserId = user.uid;
            loginSection.classList.add("hidden");
            appSection.classList.remove("hidden");
            userEmailSpan.textContent = user.email;
            fetchResumes();
          } else {
            currentUserId = null;
            loginSection.classList.remove("hidden");
            appSection.classList.add("hidden");
            allResumes = [];
            renderResumeCards([]);
          }
        });

        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          loginError.textContent = "";
          try {
            await signInWithEmailAndPassword(
              auth,
              loginForm.email.value,
              loginForm.password.value
            );
          } catch (error) {
            loginError.textContent = "Email ou senha inválidos.";
          }
        });

        logoutButton.addEventListener("click", () => signOut(auth));
      }

      // --- Public View (Read-only or Editable) ---
      async function renderPublicView(id, isEditable) {
        appContainer.innerHTML = `
                <div id="public-view-container" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                    <div id="loading-public" class="text-center py-20">
                        <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
                    </div>
                </div>`;

        try {
          const resumeDocRef = doc(db, "resumes", id);
          const resumeSnap = await getDoc(resumeDocRef);

          if (resumeSnap.exists()) {
            const resumeData = resumeSnap.data();
            const container = document.getElementById("public-view-container");

            if (isEditable) {
              document.title = `Editar Currículo - ${resumeData.name}`;
              container.innerHTML = `
                            <form id="public-edit-form">
                                <h1 class="text-3xl font-bold text-slate-800 mb-2">Atualize seu Currículo</h1>
                                <p class="text-slate-600 mb-6">Mantenha suas informações sempre em dia para novas oportunidades.</p>
                                <div id="form-content-container"></div>
                                <div class="flex justify-end pt-6 mt-4 border-t">
                                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Salvar Alterações</button>
                                </div>
                                <p id="save-feedback" class="text-center mt-4 h-6"></p>
                            </form>`;

              renderFormFields(
                document.getElementById("form-content-container")
              );
              populateForm(resumeData);

              document
                .getElementById("public-edit-form")
                .addEventListener("submit", async (e) => {
                  e.preventDefault();
                  const updatedData = getFormData();
                  const feedback = document.getElementById("save-feedback");
                  feedback.textContent = "Salvando...";
                  feedback.classList.remove("text-red-500", "text-green-500");
                  try {
                    await updateDoc(resumeDocRef, updatedData);
                    feedback.textContent = "Dados atualizados com sucesso!";
                    feedback.classList.add("text-green-500");
                  } catch (error) {
                    console.error("Error updating resume:", error);
                    feedback.textContent = "Erro ao salvar. Tente novamente.";
                    feedback.classList.add("text-red-500");
                  }
                });
            } else {
              document.title = `Currículo de ${resumeData.name}`;
              container.innerHTML = generateResumeHTML(resumeData);
            }
          } else {
            document.getElementById("public-view-container").innerHTML =
              '<p class="text-center text-red-500">Currículo não encontrado ou inválido.</p>';
          }
        } catch (e) {
          document.getElementById("public-view-container").innerHTML =
            '<p class="text-center text-red-500">Ocorreu um erro ao carregar o currículo.</p>';
          console.error(e);
        }
      }

      // --- Firestore & Data Handling ---
      function fetchResumes() {
        onSnapshot(collection(db, "resumes"), (snapshot) => {
          allResumes = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));
          allResumes.sort((a, b) => a.name.localeCompare(b.name));
          renderResumeCards(allResumes);
          loadingIndicator.classList.add("hidden");
        });
      }

      // --- Rendering Logic for Main App ---
      function renderResumeCards(resumesToRender) {
        resumeList.innerHTML = "";
        noResults.classList.toggle("hidden", resumesToRender.length > 0);

        resumesToRender.forEach((resume) => {
          const card = document.createElement("div");
          card.className =
            "bg-white rounded-xl shadow-lg p-5 flex flex-col justify-between transition-transform transform hover:scale-105";
          const skillsHTML = (resume.skills || [])
            .map(
              (s) =>
                `<span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 mb-2 px-2.5 py-0.5 rounded-full">${s.trim()}</span>`
            )
            .join("");

          card.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold text-slate-900 truncate">${
                          resume.name
                        }</h3>
                        <p class="text-sm text-slate-500 mb-4">${
                          resume.email
                        }</p>
                        <div class="flex flex-wrap mb-4">${
                          skillsHTML ||
                          '<p class="text-sm text-slate-400">Sem habilidades.</p>'
                        }</div>
                    </div>
                    <div class="border-t pt-4 mt-auto flex justify-end space-x-2">
                         <button data-id="${
                           resume.id
                         }" class="edit-btn text-slate-500 hover:text-blue-600" title="Editar"><i class="fas fa-edit"></i></button>
                         <button data-id="${
                           resume.id
                         }" class="share-btn text-slate-500 hover:text-green-600" title="Compartilhar"><i class="fas fa-share-alt"></i></button>
                         <button data-id="${
                           resume.id
                         }" class="pdf-btn text-slate-500 hover:text-red-600" title="Exportar PDF"><i class="fas fa-file-pdf"></i></button>
                         <button data-id="${
                           resume.id
                         }" class="delete-btn text-slate-500 hover:text-red-700" title="Deletar"><i class="fas fa-trash"></i></button>
                    </div>
                `;
          resumeList.appendChild(card);
        });
      }

      filterInput.addEventListener("input", (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = term
          ? allResumes.filter(
              (r) =>
                r.name.toLowerCase().includes(term) ||
                (r.skills || []).some((s) => s.toLowerCase().includes(term))
            )
          : allResumes;
        renderResumeCards(filtered);
      });

      // --- CRUD & Modal Listeners ---
      addResumeButton.addEventListener("click", () => {
        modalTitle.textContent = "Adicionar Novo Currículo";
        renderFormFields(formContainer);
        document.getElementById("resume-form").reset();
        document.getElementById("resume-id").value = "";
        resumeModal.classList.remove("hidden");
      });

      cancelButton.addEventListener("click", () =>
        resumeModal.classList.add("hidden")
      );

      resumeList.addEventListener("click", async (e) => {
        const button = e.target.closest("button");
        if (!button) return;
        const id = button.dataset.id;

        if (button.classList.contains("edit-btn")) {
          openEditModal(id);
        } else if (button.classList.contains("delete-btn")) {
          showConfirm(
            "Deletar Currículo",
            "Tem certeza? Esta ação não pode ser desfeita.",
            async () => {
              await deleteDoc(doc(db, "resumes", id));
            }
          );
        } else if (button.classList.contains("share-btn")) {
          openShareModal(id);
        } else if (button.classList.contains("pdf-btn")) {
          generatePdf(id);
        }
      });

      async function openEditModal(id) {
        const resumeDoc = doc(db, "resumes", id);
        const resumeSnap = await getDoc(resumeDoc);
        if (resumeSnap.exists()) {
          modalTitle.textContent = "Editar Currículo";
          renderFormFields(formContainer);
          populateForm(resumeSnap.data());
          document.getElementById("resume-id").value = id;
          resumeModal.classList.remove("hidden");
        }
      }

      resumeForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("resume-id").value;
        const resumeData = getFormData();

        try {
          if (id) {
            await updateDoc(doc(db, "resumes", id), resumeData);
          } else {
            await addDoc(collection(db, "resumes"), {
              ...resumeData,
              createdAt: serverTimestamp(),
            });
          }
          resumeModal.classList.add("hidden");
        } catch (error) {
          console.error("Error saving resume: ", error);
          alert("Ocorreu um erro ao salvar o currículo.");
        }
      });

      // --- Form Generation & Handling ---
      function renderFormFields(container) {
        container.innerHTML = `
                <div class="space-y-6">
                    <!-- Personal Info -->
                    <fieldset class="border p-4 rounded-lg">
                        <legend class="px-2 font-semibold text-lg text-slate-800">Dados Pessoais</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-2">
                            <div class="lg:col-span-2"><label for="name" class="block text-sm font-medium">Nome Completo</label><input type="text" id="name" required class="mt-1 w-full rounded-md border-slate-300 shadow-sm"></div>
                            <div><label for="birthDate" class="block text-sm font-medium">Data de Nascimento</label><input type="date" id="birthDate" class="mt-1 w-full rounded-md border-slate-300 shadow-sm"></div>
                            <div><label for="cpf" class="block text-sm font-medium">CPF</label><input type="text" id="cpf" placeholder="000.000.000-00" class="mt-1 w-full rounded-md border-slate-300 shadow-sm"></div>
                            <div><label for="phone" class="block text-sm font-medium">Telefone</label><input type="tel" id="phone" required class="mt-1 w-full rounded-md border-slate-300 shadow-sm"></div>
                            <div><label for="email-candidate" class="block text-sm font-medium">Email</label><input type="email" id="email-candidate" required class="mt-1 w-full rounded-md border-slate-300 shadow-sm"></div>
                            <div class="lg:col-span-3"><label for="address" class="block text-sm font-medium">Endereço Completo</label><input type="text" id="address" class="mt-1 w-full rounded-md border-slate-300 shadow-sm"></div>
                            <div><label for="gender" class="block text-sm font-medium">Gênero</label><select id="gender" class="mt-1 w-full rounded-md border-slate-300 shadow-sm"><option>Não informar</option><option>Feminino</option><option>Masculino</option><option>Outro</option></select></div>
                            <div><label for="maritalStatus" class="block text-sm font-medium">Estado Civil</label><select id="maritalStatus" class="mt-1 w-full rounded-md border-slate-300 shadow-sm"><option>Não informar</option><option>Solteiro(a)</option><option>Casado(a)</option><option>Divorciado(a)</option><option>Viúvo(a)</option></select></div>
                            <div><label for="children" class="block text-sm font-medium">Possui Filhos?</label><select id="children" class="mt-1 w-full rounded-md border-slate-300 shadow-sm"><option>Não</option><option>Sim</option></select></div>
                            <div><label for="cnh" class="block text-sm font-medium">CNH</label><select id="cnh" class="mt-1 w-full rounded-md border-slate-300 shadow-sm"><option>Nenhuma</option><option>A</option><option>B</option><option>A+B</option><option>C</option><option>D</option><option>E</option></select></div>
                            <div><label for="pcd" class="block text-sm font-medium">PCD (Pessoa com Deficiência)?</label><select id="pcd" class="mt-1 w-full rounded-md border-slate-300 shadow-sm"><option>Não</option><option>Sim</option></select></div>
                        </div>
                    </fieldset>
                    
                    <!-- Professional Info -->
                    <fieldset class="border p-4 rounded-lg">
                        <legend class="px-2 font-semibold text-lg text-slate-800">Dados Profissionais</legend>
                        <div class="space-y-4 mt-2">
                             <div><label for="summary" class="block text-sm font-medium">Resumo Profissional</label><textarea id="summary" rows="3" class="mt-1 w-full rounded-md border-slate-300 shadow-sm"></textarea></div>
                            <div><label for="skills" class="block text-sm font-medium">Habilidades (separadas por vírgula)</label><input type="text" id="skills" placeholder="Ex: Comunicação, Pacote Office" class="mt-1 w-full rounded-md border-slate-300 shadow-sm"></div>
                            <div id="experience-section"><h3 class="font-semibold text-md">Experiência Profissional</h3><div id="experience-list"></div><button type="button" class="add-dynamic-btn mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium" data-type="experience">+ Adicionar Experiência</button></div>
                            <div id="education-section"><h3 class="font-semibold text-md">Formação Acadêmica</h3><div id="education-list"></div><button type="button" class="add-dynamic-btn mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium" data-type="education">+ Adicionar Formação</button></div>
                        </div>
                    </fieldset>
                </div>
            `;
        container
          .querySelectorAll(".add-dynamic-btn")
          .forEach((btn) =>
            btn.addEventListener("click", (e) =>
              addDynamicEntry(e.target.dataset.type)
            )
          );
      }

      function populateForm(data) {
        // Simple fields
        [
          "name",
          "birthDate",
          "cpf",
          "phone",
          "email-candidate",
          "address",
          "gender",
          "maritalStatus",
          "children",
          "cnh",
          "pcd",
          "summary",
        ].forEach((key) => {
          const el = document.getElementById(key);
          if (el) el.value = data[key] || "";
        });
        document.getElementById("skills").value = (data.skills || []).join(
          ", "
        );

        // Dynamic sections
        document.getElementById("experience-list").innerHTML = "";
        document.getElementById("education-list").innerHTML = "";
        (data.experience || []).forEach((item) =>
          addDynamicEntry("experience", item)
        );
        (data.education || []).forEach((item) =>
          addDynamicEntry("education", item)
        );
      }

      function getFormData() {
        const data = {};
        [
          "name",
          "birthDate",
          "cpf",
          "phone",
          "email-candidate",
          "address",
          "gender",
          "maritalStatus",
          "children",
          "cnh",
          "pcd",
          "summary",
        ].forEach((key) => {
          const el = document.getElementById(key);
          if (el) data[key] = el.value;
        });
        data.skills = document
          .getElementById("skills")
          .value.split(",")
          .map((s) => s.trim())
          .filter(Boolean);
        data.experience = getDynamicSectionData("experience");
        data.education = getDynamicSectionData("education");
        return data;
      }

      // --- Dynamic Form Section Logic ---
      function addDynamicEntry(type, data = {}) {
        const list = document.getElementById(`${type}-list`);
        const entryDiv = document.createElement("div");
        entryDiv.className =
          "p-3 mt-2 border rounded-md relative grid grid-cols-1 md:grid-cols-2 gap-3 bg-slate-50";

        const fields =
          type === "experience"
            ? {
                position: "Cargo",
                company: "Empresa",
                period: "Período",
                description: "Descrição",
              }
            : {
                course: "Curso/Formação",
                institution: "Instituição",
                period: "Período",
              };

        let html = Object.keys(fields)
          .map((key) => {
            const isTextArea = key === "description";
            return `<div class="${isTextArea ? "md:col-span-2" : ""}">
                           <label class="block text-xs font-medium">${
                             fields[key]
                           }</label>
                           ${
                             isTextArea
                               ? `<textarea data-key="${key}" rows="2" class="mt-1 w-full rounded-md border-slate-300 shadow-sm text-sm">${
                                   data[key] || ""
                                 }</textarea>`
                               : `<input type="text" data-key="${key}" value="${
                                   data[key] || ""
                                 }" class="mt-1 w-full rounded-md border-slate-300 shadow-sm text-sm">`
                           }
                         </div>`;
          })
          .join("");

        entryDiv.innerHTML =
          html +
          `<button type="button" class="remove-btn absolute top-2 right-2 hover:text-red-700 text-red-500"><i class="fas fa-times"></i></button>`;
        entryDiv.querySelector(".remove-btn").onclick = () => entryDiv.remove();
        list.appendChild(entryDiv);
      }

      function getDynamicSectionData(type) {
        return Array.from(document.getElementById(`${type}-list`).children).map(
          (node) => {
            const entry = {};
            node
              .querySelectorAll("input, textarea")
              .forEach((input) => (entry[input.dataset.key] = input.value));
            return entry;
          }
        );
      }

      // --- Share & PDF Logic ---
      function openShareModal(id) {
        const baseUrl = `${window.location.origin}${window.location.pathname}`;
        shareLinkCompanyInput.value = `${baseUrl}?view=${id}`;
        shareLinkCandidateInput.value = `${baseUrl}?edit=${id}`;
        copyFeedback.textContent = "";
        shareModal.classList.remove("hidden");
      }
      closeShareModal.addEventListener("click", () =>
        shareModal.classList.add("hidden")
      );
      document.querySelectorAll(".copy-link-button").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const input = document.getElementById(e.target.dataset.target);
          input.select();
          document.execCommand("copy");
          copyFeedback.textContent = "Link copiado!";
          setTimeout(() => {
            copyFeedback.textContent = "";
          }, 2000);
        });
      });

      async function generatePdf(id) {
        const resumeData = allResumes.find((r) => r.id === id);
        if (!resumeData) return;
        const pdfContent = document.getElementById("pdf-content");
        pdfContent.innerHTML = generateResumeHTML(resumeData);

        await new Promise((resolve) => setTimeout(resolve, 100));
        const canvas = await html2canvas(pdfContent, { scale: 2 });
        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
        pdf.output("dataurlnewwindow");
        pdfContent.innerHTML = "";
      }

      function generateResumeHTML(resume) {
        const sectionTitleStyle =
          "font-size: 20px; font-weight: bold; color: #1e293b; border-bottom: 2px solid #3b82f6; padding-bottom: 4px; margin-bottom: 16px; margin-top: 24px;";
        const personalInfo = `
                <h2 style="${sectionTitleStyle}">Dados Pessoais</h2>
                <table style="width: 100%; font-size: 14px; border-collapse: collapse;">
                    <tr><td style="padding: 4px; font-weight: bold;">Email:</td><td style="padding: 4px;">${
                      resume["email-candidate"] || ""
                    }</td></tr>
                    <tr><td style="padding: 4px; font-weight: bold;">Telefone:</td><td style="padding: 4px;">${
                      resume.phone || ""
                    }</td></tr>
                    <tr><td style="padding: 4px; font-weight: bold;">Endereço:</td><td style="padding: 4px;">${
                      resume.address || ""
                    }</td></tr>
                    <tr><td style="padding: 4px; font-weight: bold;">Nascimento:</td><td style="padding: 4px;">${
                      resume.birthDate
                        ? new Date(
                            resume.birthDate + "T00:00:00"
                          ).toLocaleDateString("pt-BR")
                        : ""
                    }</td></tr>
                    <tr><td style="padding: 4px; font-weight: bold;">CPF:</td><td style="padding: 4px;">${
                      resume.cpf || ""
                    }</td></tr>
                    <tr><td style="padding: 4px; font-weight: bold;">CNH:</td><td style="padding: 4px;">${
                      resume.cnh || ""
                    }</td></tr>
                    <tr><td style="padding: 4px; font-weight: bold;">PCD:</td><td style="padding: 4px;">${
                      resume.pcd || ""
                    }</td></tr>
                </table>`;
        const skillsHTML = (resume.skills || [])
          .map(
            (skill) =>
              `<span style="background-color: #e0f2fe; color: #0c4a6e; font-size: 12px; font-weight: 500; margin: 0 8px 8px 0; padding: 4px 10px; border-radius: 9999px; display: inline-block;">${skill}</span>`
          )
          .join("");
        const experienceHTML = (resume.experience || [])
          .map(
            (exp) =>
              `<div style="margin-bottom: 16px;"><h4 style="font-size: 16px; font-weight: bold; color: #1e293b;">${
                exp.position || ""
              }</h4><p style="font-size: 14px; color: #475569; margin-bottom: 4px;">${
                exp.company || ""
              } | ${
                exp.period || ""
              }</p><p style="font-size: 14px; color: #64748b;">${
                exp.description || ""
              }</p></div>`
          )
          .join("");
        const educationHTML = (resume.education || [])
          .map(
            (edu) =>
              `<div style="margin-bottom: 12px;"><h4 style="font-size: 16px; font-weight: bold; color: #1e293b;">${
                edu.course || ""
              }</h4><p style="font-size: 14px; color: #475569;">${
                edu.institution || ""
              } | ${edu.period || ""}</p></div>`
          )
          .join("");

        return `
                <div style="font-family: 'Inter', sans-serif; color: #334155;">
                    <h1 style="font-size: 32px; font-weight: bold; color: #0f172a; margin-bottom: 8px;">${
                      resume.name
                    }</h1>
                    <hr style="margin: 24px 0; border-color: #e2e8f0;">
                    ${personalInfo}
                    <h2 style="${sectionTitleStyle}">Resumo Profissional</h2>
                    <p style="font-size: 14px; line-height: 1.6;">${
                      resume.summary || "Não informado."
                    }</p>
                    <h2 style="${sectionTitleStyle}">Habilidades</h2>
                    <div style="display: flex; flex-wrap: wrap;">${
                      skillsHTML || "Nenhuma habilidade cadastrada."
                    }</div>
                    <h2 style="${sectionTitleStyle}">Experiência Profissional</h2>
                    <div>${
                      experienceHTML || "Nenhuma experiência cadastrada."
                    }</div>
                    <h2 style="${sectionTitleStyle}">Formação Acadêmica</h2>
                    <div>${
                      educationHTML || "Nenhuma formação cadastrada."
                    }</div>
                </div>`;
      }

      // --- Run the App ---
      startApp();
    </script>
  </body>
</html>
